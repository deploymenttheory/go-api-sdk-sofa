name: Generate Go Structs from SOFA API

on:
  workflow_dispatch:
  schedule:
    # Run daily at 12:00 UTC to check for API updates
    - cron: '0 12 * * *'

jobs:
  generate-structs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      
    - name: Set up Go
      uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
      with:
        go-version-file: 'go.mod'
        
    - name: Install gojsonstruct
      run: go install github.com/twpayne/go-jsonstruct/cmd/gojsonstruct@latest
      
    - name: Create models directory
      run: mkdir -p sdk/models
      
    - name: Fetch macOS SOFA v1 data feed and generate structs
      run: |
        curl -s "https://sofafeed.macadmins.io/v1/macos_data_feed.json" | \
        gojsonstruct -packagename models -typename MacOSV1FeedResponse > sdk/models/macos_v1_generated.go
        
    - name: Fetch iOS SOFA v1 data feed and generate structs
      run: |
        curl -s "https://sofafeed.macadmins.io/v1/ios_data_feed.json" | \
        gojsonstruct -packagename models -typename IOSV1FeedResponse > sdk/models/ios_v1_generated.go

    - name: Fetch macOS SOFA v2data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/macos_data_feed.json" | \
        gojsonstruct -packagename models -typename MacOSV2FeedResponse > sdk/models/macos_v2_generated.go

    - name: Fetch iOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/ios_data_feed.json" | \
        gojsonstruct -packagename models -typename IOSFeedResponse > sdk/models/ios_v2_generated.go
    
    - name: Fetch tvOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/tvos_data_feed.json" | \
        gojsonstruct -packagename models -typename TVOSV2FeedResponse > sdk/models/tvos_v2_generated.go

    - name: Fetch watchOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/watchos_data_feed.json" | \
        gojsonstruct -packagename models -typename WatchOSV2FeedResponse > sdk/models/watchos_v2_generated.go
    
    - name: Fetch visionOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/visionos_data_feed.json" | \
        gojsonstruct -packagename models -typename VisionOSV2FeedResponse > sdk/models/visionos_v2_generated.go
    
    - name: Fetch Safari SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/safari_data_feed.json" | \
        gojsonstruct -packagename models -typename SafariV2FeedResponse > sdk/models/safari_v2_generated.go


    - name: go fmt generated structs
      run: go fmt sdk/models/*_generated.go
        
    - name: Create PR if changes detected
      uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Generate updated Go structs from SOFA API feeds'
        title: 'Auto-generated: Update SOFA API struct definitions'
        body: |
          This PR contains auto-generated Go struct definitions from the SOFA API feeds:
          -- v1 feeds --
          - macOS feed: https://sofafeed.macadmins.io/v1/macos_data_feed.json
          - iOS feed: https://sofafeed.macadmins.io/v1/ios_data_feed.json
          -- v2 feeds --
          - macOS feed: https://sofa.macadmins.io/v2/macos_data_feed.json
          - iOS feed: https://sofa.macadmins.io/v2/ios_data_feed.json
          - tvOS feed: https://sofa.macadmins.io/v2/tvos_data_feed.json
          - watchOS feed: https://sofa.macadmins.io/v2/watchos_data_feed.json
          - visionOS feed: https://sofa.macadmins.io/v2/visionos_data_feed.json
          - Safari feed: https://sofa.macadmins.io/v2/safari_data_feed.json
          
          Generated using gojsonstruct tool.
        branch: auto/update-structs
        delete-branch: true