name: Generate Go Structs from SOFA API

on:
  workflow_dispatch:
  schedule:
    # Run daily at 12:00 UTC to check for API updates
    - cron: '0 12 * * *'

jobs:
  generate-structs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1
      
    - name: Set up Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version-file: 'go.mod'
        
    - name: Install gojsonstruct
      run: go install github.com/twpayne/go-jsonstruct/cmd/gojsonstruct@latest
      
    - name: Create models directory
      run: mkdir -p sdk/models
      
    - name: Fetch macOS SOFA v1 data feed and generate structs
      run: |
        curl -s "https://sofafeed.macadmins.io/v1/macos_data_feed.json" | \
        gojsonstruct -packagename models -typename MacOSV1FeedResponse > sdk/models/macos_v1_generated.go
        
    - name: Fetch iOS SOFA v1 data feed and generate structs
      run: |
        curl -s "https://sofafeed.macadmins.io/v1/ios_data_feed.json" | \
        gojsonstruct -packagename models -typename IOSV1FeedResponse > sdk/models/ios_v1_generated.go

    - name: Fetch macOS SOFA v2data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/macos_data_feed.json" | \
        gojsonstruct -packagename models -typename MacOSV2FeedResponse > sdk/models/macos_v2_generated.go

    - name: Fetch iOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/ios_data_feed.json" | \
        gojsonstruct -packagename models -typename IOSFeedResponse > sdk/models/ios_v2_generated.go
    
    - name: Fetch tvOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/tvos_data_feed.json" | \
        gojsonstruct -packagename models -typename TVOSV2FeedResponse > sdk/models/tvos_v2_generated.go

    - name: Fetch watchOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/watchos_data_feed.json" | \
        gojsonstruct -packagename models -typename WatchOSV2FeedResponse > sdk/models/watchos_v2_generated.go
    
    - name: Fetch visionOS SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/visionos_data_feed.json" | \
        gojsonstruct -packagename models -typename VisionOSV2FeedResponse > sdk/models/visionos_v2_generated.go
    
    - name: Fetch Safari SOFA v2 data feed and generate structs
      run: |
        curl -s "https://sofa.macadmins.io/v2/safari_data_feed.json" | \
        gojsonstruct -packagename models -typename SafariV2FeedResponse > sdk/models/safari_v2_generated.go


    - name: go fmt generated structs
      run: go fmt sdk/models/*_generated.go
        
    - name: Get current date and time
      id: datetime
      run: echo "timestamp=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
    - name: Create PR if changes detected
      uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Generate updated Go structs from SOFA API feeds'
        title: 'Auto-generated: Update SOFA API struct definitions - ${{ steps.datetime.outputs.timestamp }}'
        body: |
          This PR contains auto-generated Go struct definitions from the SOFA API feeds.
          
          **Generated:** ${{ steps.datetime.outputs.timestamp }}
          
          ## Feeds Updated
          
          ### v1 Feeds
          - macOS: https://sofafeed.macadmins.io/v1/macos_data_feed.json
          - iOS: https://sofafeed.macadmins.io/v1/ios_data_feed.json
          
          ### v2 Feeds
          - macOS: https://sofa.macadmins.io/v2/macos_data_feed.json
          - iOS: https://sofa.macadmins.io/v2/ios_data_feed.json
          - tvOS: https://sofa.macadmins.io/v2/tvos_data_feed.json
          - watchOS: https://sofa.macadmins.io/v2/watchos_data_feed.json
          - visionOS: https://sofa.macadmins.io/v2/visionos_data_feed.json
          - Safari: https://sofa.macadmins.io/v2/safari_data_feed.json
          
          Generated using [gojsonstruct](https://github.com/twpayne/go-jsonstruct).
        branch: auto/update-structs
        delete-branch: true