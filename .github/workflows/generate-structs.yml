name: Generate Go Structs from SOFA API

on:
  workflow_dispatch:
  schedule:
    # Run daily at 12:00 UTC to check for API updates
    - cron: '0 12 * * *'

jobs:
  generate-structs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      
    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
      with:
        go-version: '1.22'
        
    - name: Install gojsonstruct
      run: go install github.com/twpayne/go-jsonstruct/cmd/gojsonstruct@latest
      
    - name: Create models directory
      run: mkdir -p sdk/models
      
    - name: Fetch macOS data feed and generate structs
      run: |
        curl -s "https://sofafeed.macadmins.io/v1/macos_data_feed.json" | \
        gojsonstruct --package-name models --typename MacOSFeedResponse --output-type separate > sdk/models/macos_generated.go
        
    - name: Fetch iOS data feed and generate structs
      run: |
        curl -s "https://sofafeed.macadmins.io/v1/ios_data_feed.json" | \
        gojsonstruct --package-name models --typename IOSFeedResponse --output-type separate > sdk/models/ios_generated.go
        
    - name: Format generated code
      run: |
        go fmt sdk/models/macos_generated.go
        go fmt sdk/models/ios_generated.go
        
    - name: Create PR if changes detected
      uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Generate updated Go structs from SOFA API feeds'
        title: 'Auto-generated: Update SOFA API struct definitions'
        body: |
          This PR contains auto-generated Go struct definitions from the SOFA API feeds:
          - macOS feed: https://sofafeed.macadmins.io/v1/macos_data_feed.json
          - iOS feed: https://sofafeed.macadmins.io/v1/ios_data_feed.json
          
          Generated using gojsonstruct tool.
        branch: auto/update-structs
        delete-branch: true